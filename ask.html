<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personal Verification Chat</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f8ff;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }
  .container {
    background: white;
    max-width: 400px;
    width: 90%;
    margin: 2rem auto;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  h1 {
    text-align: center;
    color: #333;
  }
  .chat {
    margin-top: 1rem;
    min-height: 300px;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 8px;
    background: #fafafa;
  }
  .message {
    margin-bottom: 1rem;
    line-height: 1.4;
  }
  .message.bot {
    color: #004080;
  }
  .message.user {
    color: #008000;
    text-align: right;
  }
  form {
    margin-top: 1rem;
    display: flex;
  }
  input[type="text"] {
    flex: 1;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    margin-left: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
    background: #007bff;
    color: white;
    cursor: pointer;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  @media (max-width: 480px) {
    .container {
      padding: 1rem;
    }
  }
</style>
</head>
<body>
  <div class="container" role="main" aria-live="polite">
    <h1>Welcome!</h1>
    <div class="chat" id="chat" aria-label="Chat conversation"></div>
    <form id="inputForm" autocomplete="off" aria-label="User input form">
      <input type="text" id="userInput" placeholder="Type your answer here..." aria-required="true" />
      <button type="submit" id="submitBtn">Send</button>
    </form>
  </div>

<script>
  const chat = document.getElementById('chat');
  const form = document.getElementById('inputForm');
  const input = document.getElementById('userInput');
  const submitBtn = document.getElementById('submitBtn');

  // Names to verify (case insensitive)
  const validNames = [
    'tin', 'justine', 'justin', 'justine riva', 'justin riva'
  ];

  // Expected birthday string normalized
  const expectedBirthday = 'april 26 2001';

  // State machine for conversation
  let state = 'askName';
  let visitorName = '';
  let verified = false;
  let answers = {};

  // Helper: append message to chat
  function appendMessage(text, sender = 'bot') {
    const msg = document.createElement('div');
    msg.classList.add('message', sender);
    msg.textContent = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  // Helper: normalize strings for comparison
  function normalize(str) {
    return str.trim().toLowerCase();
  }

  // Send data to Gmail via provided function
  function sendToGmail(message) {
    fetch("https://formspree.io/f/mwpedbzo", {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email: "realizanbernie6@gmail.com", message })
    }).then(response => {
      if (response.ok) console.log("Email sent successfully.");
      else console.log("Error sending email.");
    });
  }

  // Start conversation
  function startConversation() {
    appendMessage("Hi! What's your name?");
  }

  // Process input based on current state
  function processInput(inputText) {
    const text = normalize(inputText);
    switch(state) {
      case 'askName':
        visitorName = inputText.trim();
        answers.name = visitorName;
        if (validNames.includes(text)) {
          appendMessage(`Are you ${visitorName}? Please verify your birthday (e.g. April 26 2001).`);
          state = 'askBirthday';
        } else {
          appendMessage("Thanks!");
          sendToGmail(`Name: ${visitorName}\nResponse: Name not recognized.`);
          state = 'end';
          form.querySelector('input').disabled = true;
          submitBtn.disabled = true;
        }
        break;

      case 'askBirthday':
        answers.birthday = inputText.trim();
        if (text === expectedBirthday) {
          verified = true;
          appendMessage("I know you, you're the only one I love â¤ï¸. How are you?");
          state = 'askHowAreYou';
        } else {
          appendMessage("Birthday doesn't match. Verification failed. Thanks!");
          sendToGmail(`Name: ${visitorName}\nBirthday entered: ${inputText.trim()}\nVerification: Failed`);
          state = 'end';
          form.querySelector('input').disabled = true;
          submitBtn.disabled = true;
        }
        break;

      case 'askHowAreYou':
        answers.howAreYou = inputText.trim();
        if (text === 'ok' || text === 'okay' || text === 'fine' || text === 'good') {
          appendMessage("God.");
          sendToGmail(formatAnswers());
          state = 'end';
          form.querySelector('input').disabled = true;
          submitBtn.disabled = true;
        } else {
          appendMessage("Why?");
          state = 'askWhyNotOk';
        }
        break;

      case 'askWhyNotOk':
        answers.whyNotOk = inputText.trim();
        appendMessage("Did you miss me?");
        state = 'askMissMe';
        break;

      case 'askMissMe':
        answers.missMe = inputText.trim();
        if (text === 'no' || text === 'nah' || text === 'nope') {
          appendMessage("How sad ðŸ˜¢");
          sendToGmail(formatAnswers());
          state = 'end';
          form.querySelector('input').disabled = true;
          submitBtn.disabled = true;
        } else {
          appendMessage("Do you still love me?");
          state = 'askStillLove';
        }
        break;

      case 'askStillLove':
        answers.stillLove = inputText.trim();
        if (text === 'no' || text === 'nah' || text === 'nope') {
          appendMessage("ðŸ˜ž");
          sendToGmail(formatAnswers());
          state = 'end';
          form.querySelector('input').disabled = true;
          submitBtn.disabled = true;
        } else {
          appendMessage("Can we be together again? ðŸ¥ºâ¤ï¸");
          state = 'askTogetherAgain';
        }
        break;

      case 'askTogetherAgain':
        answers.togetherAgain = inputText.trim();
        if (text === 'no' || text === 'nah' || text === 'nope') {
          appendMessage("Why?");
          state = 'askWhyNoTogether';
        } else {
          appendMessage("ðŸ˜ŠðŸ’– So happy to hear that! Let's make it happen!");
          sendToGmail(formatAnswers());
          state = 'end';
          form.querySelector('input').disabled = true;
          submitBtn.disabled = true;
        }
        break;

      case 'askWhyNoTogether':
        answers.whyNoTogether = inputText.trim();
        appendMessage("Thanks for sharing. Take care!");
        sendToGmail(formatAnswers());
        state = 'end';
        form.querySelector('input').disabled = true;
        submitBtn.disabled = true;
        break;

      case 'end':
        // Do nothing, conversation ended.
        break;
    }
  }

  // Format all answers into a message string
  function formatAnswers() {
    let msg = `Conversation with ${visitorName}:\n`;
    for (const [key, value] of Object.entries(answers)) {
      msg += `${key}: ${value}\n`;
    }
    return msg;
  }

  // Event listener for form submission
  form.addEventListener('submit', e => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;
    appendMessage(userText, 'user');
    processInput(userText);
    input.value = '';
    input.focus();
  });

  // Initialize
  startConversation();
  input.focus();
</script>
</body>
</html>
